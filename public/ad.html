<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
    <script src="javascripts/tracking-min.js"></script>
    <script src="javascripts/tracking.js"></script>
    <script src="javascripts/jquery.js"></script>
    <script src="javascripts/respond.min.js"></script>
    <script src="javascripts/stats.min.js"></script>
    <script src="javascripts/main.js"></script>
    <script src="stylesheets/main.css"></script>
    <script src="javascripts/face-min.js"></script>
    <script type="text/javascript" src="javascripts/face-api.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script type="text/javascript" src="javascripts/front.to.node.js"></script>

    <title>Welcome kb141 ad</title>
    <style>
        #video, canvas {
            position: absolute;
            margin-left: 60px;
        }

        #advideo {
            position: absolute;
        }
        #log{
            margin-top: 380px;
            margin-left: 60px;
            text-align: left;
            width: 480px;
        }
    </style>
</head>
<body>
<div class="container-fluid">
    <div class="row">
        <div class="col-lg-8">
            <video autoplay preload width="auto" height="600" id="advideo"></video>
            <img id="img" width="1180px" height="720px">
        </div>
        <div class="col-lg-4">
            <div>
                <video id="video" width="480" height="360" preload autoplay loop muted></video>
                <canvas id="canvas" width="480" height="360"></canvas>
            </div>
            <div>
                <h3 id="log"></h3>
            </div>
        </div>
    </div>
</div>
<script>
    $(document).ready(function () {
        var video = document.getElementById("video");
        var canvas = document.getElementById("canvas");
        var context = canvas.getContext("2d");
        var tracker = new tracking.ObjectTracker("face");
        tracker.setInitialScale(2);
        tracker.setStepSize(2);
        tracker.setEdgesDensity(0.1);
        tracking.track("#video", tracker, {camera: true});

        var currentTime;
        var endTime;
        var makeTime;
        var time;

        var faceResult = null;
        var firstEmotionResult = null;
        var secondEmotionResult = null;

        $("#stats").css("display", "none");

//        var path = {
//            "age": 50,
//            "gender": "female",
//            "firstemotion": {
//                "anger": 0.00019452213,
//                "contempt": 0.000333736039,
//                "disgust": 0.000693641952,
//                "fear": 0.0000172743637,
//                "happiness": 0.0000509745,
//                "neutral": 0.004753512,
//                "sadness": 0.0001063,
//                "surprise": 0.00008960857
//            }
//        };
//
        modeImage();
//
//
//        var newint = setInterval(function () {
//            clearInterval(newint);
//            modeVideo(path);
//        }, 5000);


// firstpicture func......

        function modeImage() {
            cameraTrackingOn();
            if(!imgData) {
                $.ajax({
                    url: "http://localhost:8081/adfile",
                    dataType: "json",
                    success: function (data) {
                        imgData = data;
                        callImg();
                    }
                });
            } else {
                callImg();
            }
        }

        function modeVideo(path) {
            console.log("MODE VIDEO CALLED");
            clearTimeout(slideShow);
            ruleMachines(path, secondCounter);
        }

        function secondCounter(seconds) {
            console.log("SECOND COUNTER PARAM : " + seconds);
            var i = setTimeout(function () {

                // 영상이 끝나고 해야 할 일들.

                console.log("MOVIE IS END");
                $('#img').css('visibility', 'visible');
                $('#advideo').css('visibility', 'hidden');

                modeImage();

                clearTimeout(i);

            }, seconds * 1000);
        }

        function cameraTrackingOn() {
            tracker.on("track", function (event) {
                context.clearRect(0, 0, canvas.width, canvas.height);
                event.data.forEach(function (rect) {
                    context.strokeStyle = "#FF4941";
                    context.strokeRect(rect.x, rect.y, rect.width, rect.height);
                    context.font = '11px Helvetica';
                    context.fillStyle = "#fff";
                    context.fillText('x: ' + rect.x + 'px', rect.x + rect.width + 5, rect.y + 11);
                    context.fillText('y: ' + rect.y + 'px', rect.x + rect.width + 5, rect.y + 22);
                    console.log(rect.width);
                    if (rect.width > 190 && event.data.length == 1) {
                        faceDetected();
                    }
                });
            });
        }

        function faceDetected() {
            tracker.removeAllListeners();  // camera Tracking off

            // log 준비
            console.log("makeTime.....");
            context.drawImage(video, 0, 0, 480, 360);
            time = new Date();
            makeTime = time.getFullYear() + "-" + ("0" + time.getMonth() + 1).slice(-2) + "-" + ("0" + time.getDate()).slice(-2) + " " +
                ("0" + time.getHours()).slice(-2) + ":" + ("0" + time.getMinutes()).slice(-2) + ":" + ("0" + time.getSeconds()).slice(-2);
            console.log(makeTime);

            canvas.toBlob(function (blob) {
                faceAPI(blob, function (data) {
                    console.log("detected called........");
                    faceResult = data;
                });
                emotionAPI(blob, function (data) {
                    console.log("emotion called.......");
                    firstEmotionResult = data;
                    console.log(firstEmotionResult);
                });
            }, "image/png", 0);


            var intervalCount = 0;
            var apiInterval = setInterval(function () {
                if (firstEmotionResult && faceResult) {
                    clearInterval(apiInterval);

                    var currentAge = Math.floor(faceResult.age);

                    $("#log").html("첫번째" + "<br>" +
                                   "연령 :" + currentAge + "<br>" +
                                   "성별 :" + faceResult.gender + "<br>" +
                                   "행복 :" + firstEmotionResult.happiness + "<br>" +
                                   "경멸 :" + firstEmotionResult.anger  + "<br>" +
                                   "혐오 :" + firstEmotionResult.disgust + "<br>" +
                                   "공포 :" + firstEmotionResult.fear + "<br>" +
                                   "평온 :" + firstEmotionResult.neutral + "<br>" +
                                   "슬픔 :" + firstEmotionResult.sadness + "<br>" +
                                   "놀람 :" + firstEmotionResult.surprise + "<br>");
                    var newtime = new Date();
                    currentTime = newtime.setTime(newtime.getTime() - time.getTime());
                    endTime = currentTime / 1000;
                    console.log(endTime);
                    console.log("INTERVAL COUNT : " + intervalCount);

                    var path = {
                        "age" : currentAge,
                        "gender" : faceResult.gender,
                        "firstemotion" : firstEmotionResult
                    };

                    var waitTerm = setInterval(function () {
                        modeVideo(path);
                        clearInterval(waitTerm);
                    }, 1000);
                }
                intervalCount++;
            }, 200);
        }


//    twoPicture....
//        function secondPicture() {
//            tracker.on("track", function (event) {
//                context.clearRect(0, 0, canvas.width, canvas.height);
//                event.data.forEach(function (rect) {
//                    context.strokeStyle = "#FF4941";
//                    context.strokeRect(rect.x, rect.y, rect.width, rect.height);
//                    context.font = '11px Helvetica';
//                    context.fillStyle = "#fff";
//                    context.fillText('x: ' + rect.x + 'px', rect.x + rect.width + 5, rect.y + 11);
//                    context.fillText('y: ' + rect.y + 'px', rect.x + rect.width + 5, rect.y + 22);
//                    console.log(rect.width);
//                    if (event.data.length == 1) {
//                        tracker.removeAllListeners();
//                        context.drawImage(video, 0, 0, 480, 360);
//                        canvas.toBlob(function (blob) {
//                            emotionapi(blob, function (data) {
//                                console.log("emotion call  ed.......");
//                                secondEmotion = data;
//                                console.log(secondEmotion);
//                                if (secondEmotion != null) {
//                                    var newtime = new Date();
//                                    currentTime = newtime.setTime(newtime.getTime() - time.getTime());
//                                    endTime = currentTime / 1000;
//                                    console.log(endTime);
//                                    var obj = {
//                                        "detect": detect,
//                                        "befEmotion": firstemotion,
//                                        "aftEmotion": secondEmotion,
//                                        "currentTime": makeTime,
//                                        "watchTime": endTime
//                                    };
//                                    logWrite(obj);
//                                }
//                            });
//                        }, "image/png", 0);
//
//                    }
//                });
//            });
//        }


    });
</script>
</body>
</html>
