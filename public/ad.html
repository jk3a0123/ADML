<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
    <script src="javascripts/tracking-min.js"></script>
    <script src="javascripts/tracking.js"></script>
    <script src="javascripts/jquery.js"></script>
    <script src="javascripts/respond.min.js"></script>
    <script src="javascripts/stats.min.js"></script>
    <script src="javascripts/main.js"></script>
    <script src="stylesheets/main.css"></script>
    <script src="javascripts/face-min.js"></script>
    <script type="text/javascript" src="javascripts/face-api.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script type="text/javascript" src="javascripts/front.to.node.js"></script>

    <title>Welcome kb141 ad</title>
    <style>
        #video , canvas {
            position: absolute;
            margin-top: 50px;
        }
        #advideo {
            position: absolute;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="row">
        <div class="col-md-4"></div>
        <div class="col-md-4">
        </div>
        <div class="col-md-4">
            <h1 id="log"></h1>
        </div>
    <div class="row">
        <div class="col-md-4">
            <video  autoplay preload width="1080" height="720" id="advideo"></video>
            <img id="img" width=600" height="600px">
        </div>
        <div class="col-md-4">

        </div>
        <div class="col-md-4">
            <video id="video" width="480" height="360" preload autoplay loop muted ></video>
            <canvas id="canvas" width="480" height="360"></canvas>
        </div>
    </div>



    </div>
</div>
<script>
    $(document).ready(function () {
        callimg();
        var video = document.getElementById("video");
        var canvas = document.getElementById("canvas");
        var context = canvas.getContext("2d");
        var tracker = new tracking.ObjectTracker("face");
        tracker.setInitialScale(2);
        tracker.setStepSize(2);
        tracker.setEdgesDensity(0.1);
        tracking.track("#video" , tracker , { camera: true });

        var detect ;
        var firstemotion ;
        var secondEmotion;
        var currentTime ;
        var endTime ;
        var makeTime;
        var time;


        firstPicture();

// firstpicture func......
     function firstPicture() {
         tracker.on("track" , function (event) {
             context.clearRect(0,0,canvas.width , canvas.height);
             event.data.forEach(function (rect) {
                 context.strokeStyle = "#FF4941";
                 context.strokeRect(rect.x, rect.y, rect.width, rect.height);
                 context.font = '11px Helvetica';
                 context.fillStyle = "#fff";
                 context.fillText('x: ' + rect.x + 'px', rect.x + rect.width + 5, rect.y + 11);
                 context.fillText('y: ' + rect.y + 'px', rect.x + rect.width + 5, rect.y + 22);
                 console.log(rect.width);
                 if(rect.width > 200 && event.data.length ==1){
                     time = new Date();
                     makeTime = time.getFullYear() + "-" + ("0" + time.getMonth()+1).slice(-2) + "-" + ("0"+ time.getDate()).slice(-2) + " " +
                         ("0" + time.getHours()).slice(-2) + ":" + ("0" + time.getMinutes()).slice(-2) + ":" + ("0" + time.getSeconds()).slice(-2);
                     tracker.removeAllListeners();
                     console.log("makeTime.....");
                     console.log(makeTime);
                     context.drawImage(video , 0 , 0 , 480 , 360);
                     canvas.toBlob(function (blob) {
                         detectapi(blob , function (data) {
                             console.log("detected called........");
                             detect = data;
                         });
                         emotionapi(blob , function (data) {
                             console.log("emotion called.......");
                             firstemotion = data;
                             console.log(firstemotion);
                             var currentAge = Math.floor(detect.age/10)*10;
                             $("#log").html("연령대 :" + currentAge +
                                            "성별 :"+ detect.gender +
                                            "행복감 :" + firstemotion.happiness);

                             var newtime = new Date();
                             currentTime = newtime.setTime(newtime.getTime() - time.getTime());
                             endTime = currentTime/1000;
                             console.log(endTime);
                             });
                     },"image/png" , 0);
                 }
             });
         });
     }

    var t = setInterval(function () {
         console.log("interval checked...");
         if(detect != null && firstemotion != null){
             console.log("interval called!!");
             clearInterval(t);
             var obj = {"detect" : detect,
                        "emotion" : firstemotion};
             ruleBase(obj , function (time) {
                 setTimeout(function () {
                     return secondPicture();
                 }, time)
             });
         }
    },400);

     // twoPicture....
        function secondPicture() {
            tracker.on("track" , function (event) {
                context.clearRect(0,0,canvas.width , canvas.height);
                event.data.forEach(function (rect) {
                    context.strokeStyle = "#FF4941";
                    context.strokeRect(rect.x, rect.y, rect.width, rect.height);
                    context.font = '11px Helvetica';
                    context.fillStyle = "#fff";
                    context.fillText('x: ' + rect.x + 'px', rect.x + rect.width + 5, rect.y + 11);
                    context.fillText('y: ' + rect.y + 'px', rect.x + rect.width + 5, rect.y + 22);
                    console.log(rect.width);
                    if(event.data.length ==1){
                        tracker.removeAllListeners();
                        context.drawImage(video , 0 , 0 , 480 , 360);
                        canvas.toBlob(function (blob) {
                                emotionapi(blob , function (data) {
                                    console.log("emotion call  ed.......");
                                    secondEmotion = data;
                                    console.log(secondEmotion);
                                    if(secondEmotion != null){
                                        var newtime = new Date();
                                        currentTime = newtime.setTime(newtime.getTime() - time.getTime());
                                        endTime = currentTime/1000;
                                        console.log(endTime);
                                        var obj = { "detect" : detect,
                                                    "befEmotion" : firstemotion,
                                                    "aftEmotion" : secondEmotion ,
                                                    "currentTime" : makeTime ,
                                                    "watchTime" : endTime };
                                        logWrite(obj);
                                    }
                                });
                        },"image/png" , 0);

                    }
                });
            });
        }
    });
</script>
</body>
</html>
