<!DOCTYPE html>
<html lang="en">
<head>
    <!--<meta charset="UTF-8">-->
    <!--<meta name="viewport" content="width=device-width, initial-scale=1.0">-->
    <!--<meta name="description" content="">-->
    <!--<meta name="author" content="">-->
    <!--<script src="javascripts/tracking-min.js"></script>-->
    <!--<script src="javascripts/tracking.js"></script>-->
    <!--<script src="javascripts/jquery.js"></script>-->
    <!--<script src="javascripts/respond.min.js"></script>-->
    <!--<script src="javascripts/stats.min.js"></script>-->
    <!--<script src="javascripts/main.js"></script>-->
    <!--<script src="stylesheets/main.css"></script>-->
    <!--<link rel="stylesheet" href="stylesheets/bootstrap.min.css">-->
    <!--<script src="javascripts/face-min.js"></script>-->
    <!--<script type="text/javascript" src="javascripts/face-api.js"></script>-->
    <!--<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>-->
    <!--<script type="text/javascript" src="javascripts/front.to.node.js"></script>-->

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
    <script src="javascripts/tracking-min.js"></script>
    <script src="javascripts/tracking.js"></script>
    <script src="javascripts/jquery.js"></script>
    <script src="javascripts/respond.min.js"></script>
    <script src="javascripts/stats.min.js"></script>
    <script src="javascripts/main.js"></script>
    <script src="stylesheets/main.css"></script>
    <script src="javascripts/face-min.js"></script>
    <script type="text/javascript" src="javascripts/face-api.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script type="text/javascript" src="javascripts/front.to.node.js"></script>


    <title>Welcome kb141 ad</title>
    <style>
        #video, canvas {
            position: absolute;
            margin-top: 50px;
        }

        #advideo {
            position: absolute;
        }

        #log {
            margin-top: 380px;
            margin-left: 60px;
            text-align: left;
            width: 480px;
        }
    </style>


    <!-- Tell the browser to be responsive to screen width -->
    <!--<meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">-->
    <!--Bootstrap 3.3.6-->
    <!-- Font Awesome -->
    <!--<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.5.0/css/font-awesome.min.css">-->
    <!-- Ionicons -->
    <!--<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ionicons/2.0.1/css/ionicons.min.css">-->
    <!--Theme style-->
    <!--<link rel="stylesheet" href="../../dist/css/AdminLTE.min.css">-->
    <!-- AdminLTE Skins. Choose a skin from the css/skins
    folder instead of downloading all of them to reduce the load. -->
    <!--<link rel="stylesheet" href="../../dist/css/skins/_all-skins.min.css">-->

</head>
<body>
<div class="wrapper">

    <!-- Content Wrapper. Contains page content -->
    <div class="content-wrapper">
        <!-- Content Header (Page header) -->
        <section class="content-header">
            <h1>
                Blank page
                <small>it all starts here</small>
            </h1>
        </section>

        <!-- Main content -->
        <section class="content">

            <!-- Default box -->
            <!--<div class="box">-->
            <!--<div class="box-header with-border">-->
            <!--<h3 class="box-title">Title</h3>-->

            <!--<div class="box-tools pull-right">-->
            <!--<button type="button" class="btn btn-box-tool" data-widget="collapse" data-toggle="tooltip"-->
            <!--title="Collapse">-->
            <!--<i class="fa fa-minus"></i></button>-->
            <!--<button type="button" class="btn btn-box-tool" data-widget="remove" data-toggle="tooltip"-->
            <!--title="Remove">-->
            <!--<i class="fa fa-times"></i></button>-->
            <!--</div>-->
            <!--</div>-->
            <!--<div class="box-body">-->
            <!--Start creating your amazing application!-->
            <!--</div>-->
            <!--&lt;!&ndash; /.box-body &ndash;&gt;-->
            <!--<div class="box-footer">-->
            <!--Footer-->
            <!--</div>-->
            <!--&lt;!&ndash; /.box-footer&ndash;&gt;-->
            <!--</div>-->
            <!--&lt;!&ndash; /.box &ndash;&gt;-->
            <div class="row">
                <div class="col-md-6 col-md-offset-3">
                    <video autoplay preload width="auto" height="600" id="advideo"></video>
                    <img id="img" width="1180px" height="720px">
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 col-md-offset-3">
                    <video id="video" width="480" height="360" preload autoplay loop muted></video>
                    <canvas id="canvas" width="480" height="360"></canvas>
                </div>
            </div>
            <br><br><br><br>
            <div class="row">
                <div class="col-md-8 col-md-offset-2">
                    <h4 id="log"></h4>
                </div>
            </div>
        </section>
        <!-- /.content -->
    </div>
</div>
<!-- ./wrapper -->

<!--&lt;!&ndash; Bootstrap 3.3.6 &ndash;&gt;-->
<!--<script src="../../bootstrap/js/bootstrap.min.js"></script>-->
<!--&lt;!&ndash; SlimScroll &ndash;&gt;-->
<!--<script src="../../plugins/slimScroll/jquery.slimscroll.min.js"></script>-->
<!--&lt;!&ndash; FastClick &ndash;&gt;-->
<!--<script src="../../plugins/fastclick/fastclick.js"></script>-->
<!--&lt;!&ndash; AdminLTE App &ndash;&gt;-->
<!--<script src="../../dist/js/app.min.js"></script>-->
<!--&lt;!&ndash; AdminLTE for demo purposes &ndash;&gt;-->
<!--<script src="../../dist/js/demo.js"></script>-->

<script>
    $(document).ready(function () {
        var video = document.getElementById("video");
        var canvas = document.getElementById("canvas");
        var context = canvas.getContext("2d");
        var tracker = new tracking.ObjectTracker("face");
        tracker.setInitialScale(2);
        tracker.setStepSize(2);
        tracker.setEdgesDensity(0.1);
        tracking.track("#video", tracker, {camera: true});

        var currentTime;
        var endTime;
        var makeTime;
        var time;

        var faceResult = null;
        var firstEmotionResult = null;
        var secondEmotionResult = null;

        $("#stats").css("display", "none");

//        var path = {
//            "age": 50,
//            "gender": "female",
//            "firstemotion": {
//                "anger": 0.00019452213,
//                "contempt": 0.000333736039,
//                "disgust": 0.000693641952,
//                "fear": 0.0000172743637,
//                "happiness": 0.0000509745,
//                "neutral": 0.004753512,
//                "sadness": 0.0001063,
//                "surprise": 0.00008960857
//            }
//        };
//
        modeImage();
//        cameraTrackingOnSecond("second");
//        callImg();
//
//        var newint = setInterval(function () {
//            clearInterval(newint);
//            modeVideo(path);
//        }, 5000);


// firstpicture func......

        function modeImage() {
            cameraTrackingOn("first");
            if (!imgData) {
                $.ajax({
                    url: "http://localhost:8081/adfile",
                    dataType: "json",
                    success: function (data) {
                        imgData = data;
                        callImg();
                    }
                });
            } else {
                callImg();
            }
        }

        function modeVideo(path) {
            console.log("MODE VIDEO CALLED");
            clearTimeout(slideShow);
            ruleMachines(path, secondCounter);
        }

        function secondCounter(seconds) {

            cameraTrackingOnSecond("second");

            console.log("SECOND COUNTER PARAM : " + seconds);
            var i = setTimeout(function () {

                // 영상이 끝나고 해야 할 일들.

                console.log("MOVIE IS END");
                $('#img').css('visibility', 'visible');
                $('#advideo').css('visibility', 'hidden');

                // 이게 빠지고, 감지로 가야 한다.
//                faceDetected("second");
                modeImage();

                clearTimeout(i);

            }, seconds * 1000);
        }

        function cameraTrackingOn(step) {
            tracker.on("track", function (event) {
                context.clearRect(0, 0, canvas.width, canvas.height);
                event.data.forEach(function (rect) {
                    context.strokeStyle = "#FF4941";
                    context.strokeRect(rect.x, rect.y, rect.width, rect.height);
                    context.font = '11px Helvetica';
                    context.fillStyle = "#fff";
                    context.fillText('x: ' + rect.x + 'px', rect.x + rect.width + 5, rect.y + 11);
                    context.fillText('y: ' + rect.y + 'px', rect.x + rect.width + 5, rect.y + 22);
                    console.log(rect.width);
                    if (rect.width > 190 && event.data.length == 1) {
                        faceDetected(step);
                    }
                });
            });
        }


        function cameraTrackingOnSecond(step) {
            var trackingArr = new Array();
            var trackingNoFaceCount = 0;
            var detectCount = 0;

            tracker.on("track", function (event) {
                context.clearRect(0, 0, canvas.width, canvas.height);
                event.data.forEach(function (rect) {
                    context.strokeStyle = "#20ddff";
                    context.strokeRect(rect.x, rect.y, rect.width, rect.height);
                    context.font = '11px Helvetica';
                    context.fillStyle = "#fff";
                    context.fillText('x: ' + rect.x + 'px', rect.x + rect.width + 5, rect.y + 11);
                    context.fillText('y: ' + rect.y + 'px', rect.x + rect.width + 5, rect.y + 22);
                    console.log(rect.width);

                    if (detectCount % 3 == 0) {

                        if (rect.width > 160 && event.data.length == 1) {
                            console.log("찰칵!");
                            context.drawImage(video, 0, 0, 480, 360);
                            canvas.toBlob(function (blob) {
                                trackingArr.unshift(blob);
                                if (trackingArr.length > 5) {
                                    trackingArr.length = 5;
                                }
                                trackingNoFaceCount = 0;
                            }, "image/png", 0);

                        } else if (trackingNoFaceCount > 5) {
                            var trackingArrLength = trackingArr.length;
                            emotionAPI(trackingArr[trackingArrLength - 1], function (data) {
                                console.log("emotion called.......");
                                trackingArr.length = 0;
                                secondEmotionResult = data;
                                console.log("SECOND EMOTION : " + secondEmotionResult);
                            });
                            tracker.removeAllListeners();  // camera Tracking off
                            faceVerify("second");
                        } else {
                            trackingNoFaceCount++;
                        }
                    }
                    detectCount++;

                });
            });
        }


        function faceDetected(step) {
            tracker.removeAllListeners();  // camera Tracking off

            // log 준비
            console.log("makeTime.....");
            context.drawImage(video, 0, 0, 480, 360);
            time = new Date();
            makeTime = time.getFullYear() + "-" + ("0" + time.getMonth() + 1).slice(-2) + "-" + ("0" + time.getDate()).slice(-2) + " " +
                ("0" + time.getHours()).slice(-2) + ":" + ("0" + time.getMinutes()).slice(-2) + ":" + ("0" + time.getSeconds()).slice(-2);
            console.log(makeTime);

            canvas.toBlob(function (blob) {
                if (step == "first") {
                    faceResult = null;
                    firstEmotionResult = null;
                    faceAPI(blob, function (data) {
                        console.log("detected called........");
                        faceResult = data;
                    });

                    emotionAPI(blob, function (data) {
                        console.log("emotion called.......");
                        firstEmotionResult = data;
//                    console.log(firstEmotionResult);
                    });
                } else if (step == "second") {
                    secondEmotionResult = null;
                    emotionAPI(blob, function (data) {
                        console.log("emotion called.......");
                        secondEmotionResult = data;
                        console.log("SECOND EMOTION : " + secondEmotionResult);
                    });
                }
                faceVerify(step);
            }, "image/png", 0);
        }

        function faceVerify(step) {
            var intervalCount = 0;

            if (step == "first") {
                var apiInterval = setInterval(function () {
                    if (firstEmotionResult && faceResult) {
                        if (firstEmotionResult == 'error' || faceResult == 'error') {
                            clearInterval(apiInterval);
                            cameraTrackingOn("first");
                        } else {
                            clearInterval(apiInterval);
                            var currentAge = Math.floor(faceResult.age);

                            $("#log").html("첫번째" + "<br>" +
                                "연령 :" + faceResult.age + "<br>" +
                                "성별 :" + faceResult.gender + "<br>" +
                                "행복 :" + firstEmotionResult.happiness + "<br>" +
                                "경멸 :" + firstEmotionResult.anger + "<br>" +
                                "혐오 :" + firstEmotionResult.disgust + "<br>" +
                                "공포 :" + firstEmotionResult.fear + "<br>" +
                                "평온 :" + firstEmotionResult.neutral + "<br>" +
                                "슬픔 :" + firstEmotionResult.sadness + "<br>" +
                                "놀람 :" + firstEmotionResult.surprise + "<br>");

                            var newtime = new Date();
                            currentTime = newtime.setTime(newtime.getTime() - time.getTime());
                            endTime = currentTime / 1000;
                            console.log(endTime);
                            console.log("INTERVAL COUNT : " + intervalCount);

                            var path = {
                                "age": currentAge,
                                "gender": faceResult.gender,
                                "firstemotion": firstEmotionResult
                            }

                            var waitTerm = setInterval(function () {
                                modeVideo(path);
                                clearInterval(waitTerm);
                            }, 1000);
                        }
                    }
                    intervalCount++;
                }, 200);
            } else if (step == "second") {
                var apiInterval = setInterval(function () {
                    if (secondEmotionResult) {
                        clearInterval(apiInterval);
                        $("#log").append(
                            "행복 2 :" + secondEmotionResult.happiness + "<br>" +
                            "경멸 2 :" + secondEmotionResult.anger + "<br>" +
                            "혐오 2 :" + secondEmotionResult.disgust + "<br>" +
                            "공포 2 :" + secondEmotionResult.fear + "<br>" +
                            "평온 2 :" + secondEmotionResult.neutral + "<br>" +
                            "슬픔 2 :" + secondEmotionResult.sadness + "<br>" +
                            "놀람 2 :" + secondEmotionResult.surprise + "<br>");
//                        var newtime = new Date();
//                        currentTime = newtime.setTime(newtime.getTime() - time.getTime());
//                        endTime = currentTime / 1000;
//                        console.log(endTime);
                        console.log("INTERVAL COUNT : " + intervalCount);
                    }
                    intervalCount++;
                }, 200);
            }
        }


//    twoPicture....
//        function secondPicture() {
//            tracker.on("track", function (event) {
//                context.clearRect(0, 0, canvas.width, canvas.height);
//                event.data.forEach(function (rect) {
//                    context.strokeStyle = "#FF4941";
//                    context.strokeRect(rect.x, rect.y, rect.width, rect.height);
//                    context.font = '11px Helvetica';
//                    context.fillStyle = "#fff";
//                    context.fillText('x: ' + rect.x + 'px', rect.x + rect.width + 5, rect.y + 11);
//                    context.fillText('y: ' + rect.y + 'px', rect.x + rect.width + 5, rect.y + 22);
//                    console.log(rect.width);
//                    if (event.data.length == 1) {
//                        tracker.removeAllListeners();
//                        context.drawImage(video, 0, 0, 480, 360);
//                        canvas.toBlob(function (blob) {
//                            emotionapi(blob, function (data) {
//                                console.log("emotion call  ed.......");
//                                secondEmotion = data;
//                                console.log(secondEmotion);
//                                if (secondEmotion != null) {
//                                    var newtime = new Date();
//                                    currentTime = newtime.setTime(newtime.getTime() - time.getTime());
//                                    endTime = currentTime / 1000;
//                                    console.log(endTime);
//                                    var obj = {
//                                        "detect": detect,
//                                        "befEmotion": firstemotion,
//                                        "aftEmotion": secondEmotion,
//                                        "currentTime": makeTime,
//                                        "watchTime": endTime
//                                    };
//                                    logWrite(obj);
//                                }
//                            });
//                        }, "image/png", 0);
//
//                    }
//                });
//            });
//        }


    });
</script>
</body>
</html>
